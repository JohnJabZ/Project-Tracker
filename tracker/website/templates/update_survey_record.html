{% extends 'base.html' %}
{% load tz %}
{% block content %}
<div class="col-md-6 offset-md-3 text-center mt-5">
    <h1>Update Data</h1><br>
    <form method="POST" action="">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.cluster_name.label_tag }} {{ form.cluster_name }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.work_order.label_tag }} {{ form.work_order }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.region.label_tag }} {{ form.region }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.project_type.label_tag }} {{ form.project_type }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.RITM.label_tag }} {{ form.RITM }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.target_area.label_tag }} {{ form.target_area }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.date_assigned.label_tag }} {{ form.date_assigned }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.status.label_tag }} {{ form.status }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.responsible.label_tag }} {{ form.responsible }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.tools.label_tag }} {{ form.tools }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.wo_status.label_tag }} {{ form.wo_status }}
            </div>

            <div class="col-md-6 mb-3">
                {{ form.priority.label_tag }} {{ form.priority }}
            </div>

            <div class="col-md-12 mb-3">
                {{ form.remarks.label_tag }} {{ form.remarks }}
            </div>
        </div>
        <br>
        <button type="submit" class="btn btn-outline-primary">Update Record</button>
        <a class="btn btn-outline-secondary" aria-current="page" href="{% url 'survey' %}">Back</a><br>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const statusField = document.getElementById("id_status");
            const responsibleField = document.getElementById("id_responsible");
            const woStatusField = document.getElementById("id_wo_status");
            const toolsField = document.getElementById("id_tools");
            const priorityField = document.getElementById("id_priority");

            const statusMapping = {
                "1 - Overlapping Clearance": { responsible: "Hajdyah", wo_status: "In Progress" },
                "2 - Parceling Stage": { responsible: "Mr. Harris", wo_status: "In Progress" },
                "3 - GIS Post": { responsible: "Dawiyat", wo_status: "In Progress" },
                "4 - Survey tool Access": { responsible: "Dawiyat", wo_status: "In Progress" },
                "5 - Survey Stage": { responsible: "Hajdyah", wo_status: "In Progress" },
                "6 - Cluster ID Acquisition": { responsible: "Hajdyah", wo_status: "In Progress" },
                "7 - HLD Package Submission": { responsible: "Mr. Harris", wo_status: "In Progress" },
                "8 - HLD Package Approval": { responsible: "Dawiyat", wo_status: "In Progress" },
                "9 - Completed": { responsible: "Done", tools: "5 - Completed", wo_status: "Completed", priority: "Done" },
                "10 - For Cancellation": { responsible: "Hajdyah", tools: "6 - For Cancellation", wo_status: "In Progress", priority: "High" },
                "11 - Cancelled": { responsible: "Done", tools: "7 - Cancelled", wo_status: "Cancelled", priority: "Done" }
            };

            function autoPopulateFields() {
                const selectedStatus = statusField.value;
                if (statusMapping[selectedStatus]) {
                    const mapping = statusMapping[selectedStatus];

                    responsibleField.value = mapping.responsible || responsibleField.value;
                    woStatusField.value = mapping.wo_status || woStatusField.value;
                    if (mapping.tools) toolsField.value = mapping.tools;
                    if (mapping.priority) priorityField.value = mapping.priority;
                }
            }

            statusField.addEventListener("change", autoPopulateFields);

            // Trigger on page load in case a value is pre-selected
            autoPopulateFields();
        });
    </script>

    <br><br>
    <!-- Collapsible Logs Section -->
    <div class="container mt-4">
        <button class="btn btn-secondary mb-3 btn-sm" type="button" data-bs-toggle="collapse"
            data-bs-target="#activityLogs">
            View Change Logs
        </button>

        <div class="collapse" id="activityLogs">
            <div class="card card-body">
                <h5>Activity Logs</h5>

                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.timestamp|localtime|date:"Y-m-d h:i A" }}</td>
                            <td>{{ log.user }}</td>
                            <td style="white-space: pre-line;">{{ log.action }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center">No Activity Logs Found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    {% endblock %}
{% extends 'base.html' %}
{% load tz %}
{% block content %}

<div class="container mt-5">

    <!-- Page Title -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">‚úè Update Design Record</h2>
        <p class="text-muted">Modify the information below and click Update</p>
    </div>

    <!-- Form Card -->
    <div class="card shadow-lg rounded-4 border-0">
        <div class="card-body p-4">

            <form method="POST" action="">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.cluster_name.label_tag }} {{ form.cluster_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.work_order.label_tag }} {{ form.work_order }}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.subclass.label_tag }} {{ form.subclass }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.RITM.label_tag }} {{ form.RITM }}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.design_type.label_tag }} {{ form.design_type }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.project_type.label_tag }} {{ form.project_type }}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.district_name.label_tag }} {{ form.district_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.region.label_tag }} {{ form.region }}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.target_area.label_tag }} {{ form.target_area }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.year.label_tag }} {{ form.year }}
                    </div>

                    <div class="col-md-6 mb-3">
                        {{ form.date_assigned.label_tag }} {{ form.date_assigned }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.status.label_tag }} {{ form.status }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.responsible.label_tag }} {{ form.responsible }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.tools.label_tag }} {{ form.tools }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.wo_status.label_tag }} {{ form.wo_status }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.priority.label_tag }} {{ form.priority }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.scope_work.label_tag }} {{ form.scope_work }}
                    </div>

                    <div class="col-md-12 mb-3">
                        {{ form.remarks.label_tag }}
                        {{ form.remarks }}
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary px-4 me-2">
                        üíæ Update Record
                    </button>
                    <a href="{% url 'design' %}" class="btn btn-secondary px-4">
                        ‚Üê Back
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="mt-4 text-center">
        <button class="btn btn-outline-dark btn-sm mb-2" type="button" data-bs-toggle="collapse"
            data-bs-target="#activityLogs">
            üìú View Activity Logs
        </button>

        <div class="collapse" id="activityLogs">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold">Change Logs</div>

                <div class="card-body p-0">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td class="text-center">{{ log.timestamp|localtime|date:"Y-m-d h:i A" }}</td>
                                <td class="text-center">{{ log.user }}</td>
                                <td style="white-space: pre-line;">{{ log.action }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center py-3">No Activity Logs Found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Auto Mapping Script (unchanged)
    document.addEventListener("DOMContentLoaded", function () {
        const statusField = document.getElementById("id_status");
        const responsibleField = document.getElementById("id_responsible");
        const woStatusField = document.getElementById("id_wo_status");
        const toolsField = document.getElementById("id_tools");
        const priorityField = document.getElementById("id_priority");

        const statusMapping = {
            "For Survey": { responsible: "Hajdyah", wo_status: "In Progress" },
            "For Submission": { responsible: "Mr. Harris", wo_status: "In Progress" },
            "For Approval": { responsible: "Dawiyat", wo_status: "In Progress" },
            "Completed": { responsible: "NA", tools: "5 - Completed", wo_status: "Completed", priority: "NA" },
            "For Cancellation": { responsible: "Hajdyah", tools: "6 - For Cancellation", wo_status: "In Progress", priority: "High" },
            "Cancelled": { responsible: "NA", tools: "7 - Cancelled", wo_status: "Cancelled", priority: "NA" }
        };

        function autoPopulateFields() {
            const selectedStatus = statusField.value;
            if (statusMapping[selectedStatus]) {
                const mapping = statusMapping[selectedStatus];
                responsibleField.value = mapping.responsible || responsibleField.value;
                woStatusField.value = mapping.wo_status || woStatusField.value;
                if (mapping.tools) toolsField.value = mapping.tools;
                if (mapping.priority) priorityField.value = mapping.priority;
            }
        }

        statusField.addEventListener("change", autoPopulateFields);
        autoPopulateFields();
    });
</script>

{% endblock %}